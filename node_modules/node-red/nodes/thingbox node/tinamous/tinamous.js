/**
 * Copyright 2014 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
 
module.exports = function(RED) {
	var request = require('request');

	function sendTinamous(account, basic_key, field, value, timestamp, format) {

		var date = new Date(timestamp);		
		var shift = ((date.toTimeString().substr(12,5))*-1).toString();
		
		date = date.toISOString();
		shift = shift.replace(shift.substr(1,1), "0"+shift.substr(1,1)+":");
		
		if (format == "realt") {
			date = date.replace("Z", "+00:00");
		} else {
			date = date.replace("Z", shift);
		}
		
		var msg ='{"'+field+'": "'+value+'", "Date": "'+date+'"}';

		console.log('\nMessage :\n'+msg);
		
		var myUrl = "https://"+account+".Tinamous.com/api/v1/Measurements";
		var user = "Basic "+basic_key;

		request.post({
			headers : {
				"Authorization" : user,
				"Content-type" : "application/json"
			},
			url : myUrl,
			body : msg
		}, function(error, response, body) {
			if(error)
				console.log("\n[Tinamous] Error sending data\n");
		});
	}

	function TinamousNode(n) {

		RED.nodes.createNode(this,n);

		this.on("input", function(msg) {
			
			var account = msg.account||n.account;
			var basic_key = msg.basic_key||n.basic_key;
			var field = msg.field||n.field;
			var value = msg.payload;
			var timestamp =  msg.timestamp || Date.now();
			var format = n.format;

			sendTinamous(account, basic_key, field, value, timestamp, format);
		});
	}

	RED.nodes.registerType("tinamous",TinamousNode);
}