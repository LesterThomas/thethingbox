var RED = require(process.env.NODE_RED_HOME+"/red/red");
var connectionPool = require("../../core/io/lib/mqttConnectionPool");


function XivelyMQTTNode(n) {

	RED.nodes.createNode(this,n);

	var api_key = n.api_key;
	var client = connectionPool.get("api.xively.com", 1883, null, api_key, null);
	client.connect();

	
	this.on("input", function(msg) {
    	
		var feed_id = msg.feed_id ||n.feed_id;
        var id_data = msg.id_data||n.id_data;
        var value = msg.payload;

        id_data = id_data.split(' ').join('_');
		id_data = id_data.split('\'').join('_');
        
    	client.publish({
    		payload: id_data+","+value,
    		topic: "/v2/feeds/"+feed_id+".csv",
    	});
        
    });
}

RED.nodes.registerType("xively_mqtt",XivelyMQTTNode);
